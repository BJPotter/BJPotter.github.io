---
title: 数仓分层
---

## 一、数仓分层

### 1.数仓概念

#### 1.1 什么是数据仓库

>数据仓库，英文名称为`Data Warehouse`，可简写为`DW`或`DWH`,是为企业所有级别的决策制定过程，提供所有类型数据支持的战略集合。**它出于分析性报告和决策支持目的而创建**。

#### 1.2 数据仓库作用

>构建面向分析的集成化数据环境，提供指导业务流程改进、监视时间、成本、质量以及控制。数据仓库本身并不 “生产” 任何数据，同时自身也不需要 “消费” 任何的数据，数据来源于外部，并且开放给外部应用，这也是为什么叫 “仓库” ，而不叫 “工厂” 的原因。

#### 1.3 数据仓库的特点

##### 1.3.1 面向主题

>操作型数据库的数据组织面向事务处理任务，各个业务系统之间各自分离，而数据仓库中的数据是按照一定的主题域进行组织。主题是一个抽象的概念，是指用户使用数据仓库进行决策时所关心的重点方面，一个主题通常包含多个操作型信息系统。

##### 1.3.2 集成

>面向事务处理的操作型数据库通常与某些特定的应用相关，数据库之间相互独立，并且往往是异构的。而数据仓库中的数据是在对原有分散的数据库数据抽取、清理的基础上经过系统加工、汇总和整理得到的，必须消除元数据中的不一致性，以保证数据仓库内的信息关于整个企业的一致的全局信息。

##### 1.3.3 不可更新

>操作型数据库中的数据通常实时更新，数据根据需要及时发生变化。数据仓库的数据主要供企业决策分析之用，所涉及的数据操作主要是数据查询，一旦某个数据进入数据很残酷以后，一般情况下将被长期保留，也就是数据仓库中一般有大量的查询操作，但修改和删除操作很少，通常只需要定期的加载、刷新。

##### 1.3.4 时变性

>操作型数据库主要关心当前某一个时间段内的数据，而数据仓库中的数据通常包含历史信息，系统记录了企业从过去某一个时点（如开始应用数据仓库的时点）到目前的各个阶段的信息，通过这些信息，可以对企业的发展历程和未来趋势做出定量分析和预测。

#### 1.4 数据仓库中的数据

>包括元数据，粒度数据、当前详细数据，历史数据、档案数据。

1.4.1 元数据

> 最重要的部分，关于数据的数据。也成为数据仓库的结构，是所有数据集成体现。仓库开发者使用元素来管理和控制仓库的建立和维护。

1.4.2 粒度数据

> 定义为呼叫仓库所保存的信息的概要程度。不同粒度表示为不同级别的汇总数据。汇总数据是信息仓库的特点，所有的企业数据分类（按部门、地区、功能等）需要的信息都不同，同时有效的信息仓库是未不同风格提供的，轻量级汇总数据是企业自行的主要依据，它来自根据企业组成部分的轻量级汇总数据或来自当前详细数据。这一层的数据容量比其他任何一个都少，代表一个折衷的积累，用来支撑广泛的各式的需要和兴趣。通过高度汇总，执行者能够使用“钻取”到达逐步增加的详细层。

1.4.3 当前详细数据

> 是信息仓库的核心，存放大量数据。数据来自业务操作数据库，通过主题来组织，不是代表特定应用，而是代表整个企业。在仓库中数据粒度最低，当数据精确化时，其中的每一个数据实体都是一个块照、一个时刻，表示一个瞬间。一旦需要经常支持企业需求，数据随即进行更新。

1.4.4 历史数据

> 以前的有意义数据（一般两年以上），给企业带来延续的利益和价值。包含巨大的数据量，可以用来预测和趋势分析。包括：旧数据（原始或汇总形式）、描述旧数据特征的元数据。

#### 1.5 数据仓库的基本架构

>数据仓库的目的是构建面向分析的继承化数据环境，为企业提供决策支持（Decision Support）。其实数据仓库本身并不“生产”然后数据，同时自身也不需要“消费”任何数据，数据来源于外部，并且开放给外部应用，这也是为什么叫“仓库”，而不叫“工厂”的原因。因此数据仓库的基本架构主要包含的数据流入流出的过程，可以分为三层
>
>--原始层（元数据）
>
>--仓库层（数据仓库）
>
>--应用层（数据应用）

<img src="https://pic4.zhimg.com/80/v2-91d6a6ca901449e1e3dc96851f408453_1440w.webp" alt="img" style="zoom: 50%;" />

<img src="C:\Users\Administrator\AppData\Local\Temp\WeChat Files\1bcb8ac1f3fd27d4452992905efd093.jpg" alt="1bcb8ac1f3fd27d4452992905efd093" style="zoom: 50%;" />





#### 1.6 数据库和数据仓库的区别

<img src="https://pic1.zhimg.com/80/v2-ce707b3e18e8fa5bb6adc377acedcf78_1440w.webp" alt="img" style="zoom:50%;" />

数据仓库是在传统数据库的基础之上发展起来的，但它并不是对传统数据库的彻底抛弃，而是旨在弥补传统数据库在数据分析能力方面的不足，以提供良好的大规模数据分析能力为己任，力图为决策提供有效的技术支持。和传统数据库相比，数据仓库在总体特征、面向用户、存储内容等方面，都有着重大的差异（如下表）。

<img src="https://pic2.zhimg.com/80/v2-a0874931c5b236e904ff335547bf88ad_1440w.webp" alt="img" style="zoom: 33%;" />

### 2.原始数据层

>ODS(Operational Data Store)
>
>1. 保持数据原貌，不做任何修改
>2. 压缩采用 LZO，压缩比是 100g 数据压缩完 10g 左右。
>3. 创建分区表

### 3.明细数据层

>DWD
>
>1.数据清洗
>	（1）空值去除
>	（2）过滤核心字段无意义的数据，比如订单表中订单 id 为 null，支付表中支付 id 为空
>	（3）将用户行为宽表和业务表进行数据一致性处理
>
>2.清洗的手段
>	Sql、mr、rdd、kettle、Python等等
>
>3.清洗掉多少数据算合理
>	1 万条数据清洗掉 1 条。
>
>4.脱敏
>	对手机号、身份证号等敏感数据脱敏
>
>5.维度退化
>	对业务数据传过来的表进行维度退化和降维。（商品一级二级三级、省市县、年月日）
>
>6.LZO压缩
>
>7.列式存储 parquet

### 4.服务数据层

>DWS
>
>1. DWS 层有 3-5 张宽表（处理 100-200 个指标 70%以上的需求）
>
>  	具体宽表名称：用户行为宽表，用户购买商品明细行为宽表，商品宽表，购物车宽表，物流宽表、登录注册、售后等。
>
>2. 哪个宽表最宽？大概有多少个字段？
>    最宽的是用户行为宽表。大概有 60-100 个字段
>
>3. 具体用户行为宽表字段名称
>    评论、打赏、收藏、关注–商品、关注–人、点赞、分享、好价爆料、文章发布、活跃、签到、补签卡、幸运屋、礼品、金币、电商点击、gmv

### 5.主题数据层

>DWT
>
>分析过的指标
>日活、月活、周活、留存、留存率、新增（日、周、年）、转化率、流失、回流、七天内连续 3 天登录（点赞、收藏、评价、购买、加购、下单、活动）、连续 3 周（月）登录、GMV、复购率、复购率排行、点赞、评论、收藏、领优惠价人数、使用优惠价、沉默、值不值得买、退款人数、退款率 topn 热门商品
>
>留转 G 复活指标
>（1）活跃
>日活：100 万 ；月活：是日活的 2-3 倍 300 万
>总注册的用户多少？1000 万-3000 万之间
>（2）GMV
>GMV：每天 10 万订单 （50 – 100 元） 500 万-1000 万
>10%-20% 100 万-200 万
>（3）复购率
>某日常商品复购；（手纸、面膜、牙膏）10%-20%
>电脑、显示器、手表 1%
>（4）转化率
>商品详情 =》 加购物车 =》下单 =》 支付
>5%-10% 60-70% 90%-95%
>（5）留存率
>1/2/3、周留存、月留存
>搞活动： 10-20%

### 6.应用数据层

>1. 如何分析用户活跃？
>     在启动日志中统计不同设备 id 出现次数。
>
>2. 如何分析用户新增?
>     用活跃用户表 left join 用户新增表，用户新增表中 mid 为空的即为用户新增。
>
>3. 如何分析用户 1 天留存？
>     留存用户=前一天新增 join 今天活跃
>     用户留存率=留存用户/前一天新增
>
>4. 如何分析沉默用户？
>     (登录时间为 7 天前,且只出现过一次)
>     按照设备 id 对日活表分组，登录次数为 1，且是在一周前登录。
>
>5. 如何分析本周回流用户？
>     本周活跃 left join 本周新增 left join 上周活跃，且本周新增 id 和上周活跃 id 都为 null。
>
>6. 如何分析流失用户？
>     (登录时间为 7 天前)
>     按照设备 id 对日活表分组，且七天内没有登录过。
>
>7. 如何分析最近连续 3 周活跃用户数？
>     按照设备 id 对周活进行分组，统计次数大于 3 次。
>
>8. 如何分析最近七天内连续三天活跃用户数？
>     1）查询出最近 7 天的活跃用户，并对用户活跃日期进行排名
>     2）计算用户活跃日期及排名之间的差值
>     3）对同用户及差值分组，统计差值个数
>     4）将差值相同个数大于等于 3 的数据取出，然后去重，即为连续 3 天及以上活跃的用户
>     7天连续收藏、点赞、购买、加购、付款、浏览、商品点击、退货、1 个月连续 7 天、连续两周

## 二、数仓建模

### 1.常用建模工具

>PowerDesigner/SQLYog/EZDML

### 2.ODS层

>1. 保持数据原貌不做任何修改，起到备份数据的作用。
>2. 数据采用压缩，减少磁盘存储空间（例如：原始数据 100G，可以压缩到 10G 左右）
>3. 创建分区表，防止后续的全表扫描

### 3.DWD层

>DWD 层需构建维度模型，一般采用星型模型，呈现的状态一般为星座模型。维度建模一般按照以下四个步骤：
>
>选择业务过程→声明粒度→确认维度→确认事实
>
>（1）选择业务过程
>
>在业务系统中，如果业务表过多，挑选我们感兴趣的业务线，比如下单业务，支付业务，退款业务，物流业务，一条业务线对应一张事实表。如果小公司业务表比较少，建议选择所有业务线。
>
>（2）声明粒度
>
>数据粒度指数据仓库的数据中保存数据的细化程度或综合程度的级别。
>声明粒度意味着精确定义事实表中的一行数据表示什么，应该尽可能选择最小粒度，以此来应各种各样的需求。
>典型的粒度声明如下：
>
>订单当中的每个商品项作为下单事实表中的一行，粒度为每次
>每周的订单次数作为一行，粒度为每周。
>每月的订单次数作为一行，粒度为每月。
>注意：如果在 DWD 层粒度就是每周或者每月，那么后续就没有办法统计细粒度的指标了。所有建议采用最小粒度。
>（3）确定维度
>
>维度的主要作用是描述业务是事实，主要表示的是“谁，何处，何时”等信息。例如：
>时间维度、用户维度、地区维度等常见维度。
>
>（4）确定事实
>
>此处的“事实”一词，指的是业务中的度量值，例如订单金额、下单次数等。
>在 DWD 层，以业务过程为建模驱动，基于每个具体业务过程的特点，构建最细粒度的明细层事实表。事实表可做适当的宽表化处理。
>
>根据维度建模中的星型模型思想，将维度进行退化。例如：地区表和省份表退化为地区维度表，商品表、品类表、spu 表、商品三级分类、商品二级分类、商品一级分类表退化为商品维度表，活动信息表和活动规则表退化为活动维度表。至此，数仓的维度建模已经完毕，DWS、DWT 和 ADS 和维度建模已经没有关系了。DWS 和 DWT 都是建宽表，宽表都是按照主题去建。主题相当于观察问题的角度，对应着维度表。

### 4.DWS层

>DWS 层统计各个主题对象的当天行为，服务于 DWT 层的主题宽表。DWS层的宽表字段，是站在不同维度的视角去看事实表，重点关注事实表的度量值，通过与之关联的事实表，获得不同的事实表的度量值。

### 5.DWT层

>以分析的主题对象为建模驱动，基于上层的应用和产品的指标需求，构建主题对象的全量宽表。
>DWT 层主题宽表都记录什么字段？
>每个维度关联的不同事实表度量值以及首次、末次时间、累积至今的度量值、累积某个时间段的度量值。

### 6.ADS层

>分别对设备主题、会员主题、商品主题和营销主题进行指标分析，其中营销主题是用户主题和商品主题的跨主题分析案例



